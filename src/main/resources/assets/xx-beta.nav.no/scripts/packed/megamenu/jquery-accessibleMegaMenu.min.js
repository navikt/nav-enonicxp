/*
Copyright © 2013 Adobe Systems Incorporated.

Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/


/*
This script has been modified to fit the needs of NAV (The Norwegian Labour and Welfare Administration), 2013-2014.
Some functions removed, some modified, others added.
Original source: https://github.com/adobe-accessibility/Accessible-Mega-Menu
*/

!function($,window){"use strict";function AccessibleMegaMenu(element,options){this.element=element,this.settings=$.extend({},defaults,options),this._defaults=defaults,this._name=pluginName,this.init()}function visible(element){return $.expr.filters.visible(element)&&!$(element).parents().addBack().filter(function(){return"hidden"===$.css(this,"visibility")}).length}function focusable(element,isTabIndexNotNaN){var map,mapName,img,nodeName=element.nodeName.toLowerCase();return"area"===nodeName?(map=element.parentNode,mapName=map.name,element.href&&mapName&&"map"===map.nodeName.toLowerCase()?(img=$("img[usemap=#"+mapName+"]")[0],!!img&&visible(img)):!1):(/input|select|textarea|button|object/.test(nodeName)?!element.disabled:"a"===nodeName?element.href||isTabIndexNotNaN:isTabIndexNotNaN)&&visible(element)}var pluginName="accessibleMegaMenu",defaults={uuidPrefix:"accessible-megamenu",menuClass:"accessible-megamenu",topNavItemClass:"topnavitem",panelClass:"accessible-megamenu-panel",panelGroupClass:"accessible-megamenu-panel-group",hoverClass:"hover",focusClass:"focus",openClass:"open",selectedTopNavItem:"selected-topnavitem",jsAnimatedClass:"js-animated",jsMenuExpandedClass:"js-menu-expanded",enableMobileMenu:!1},Keyboard={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38,keyMap:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",190:"."}};AccessibleMegaMenu.prototype=function(){var _getPlugin,_addUniqueId,_togglePanel,_clickHandler,_clickOutsideHandler,_keyDownHandler,_toggleExpandedEventHandlers,_mobileMenuInit,_mobileMenuEnable,_mobileMenuDisable,_toggleMobilePanel,_toggleMobileMenuAndSearch,_getFooterLinks,_splitListItems,uuid=0,keydownTimeoutDuration=1e3,keydownSearchString="",isTouch=!!Object.prototype.hasOwnProperty.call(window,"ontouchstart"),mobileMenuMq=window.matchMedia("(max-width: 48em)"),_getTouchEvent=function(event){return event.originalEvent.targetTouches?event.originalEvent.targetTouches[0]:event};return _mobileMenuEnable=function(submenu,expander){expander.attr({tabindex:0,"aria-haspopup":!0,"aria-owns":submenu.attr("id"),"aria-controls":submenu.attr("id"),"aria-expanded":!1}),submenu.attr({role:"group","aria-expanded":!1,"aria-hidden":!0}).not("[aria-labelledby]").attr("aria-labelledby",expander.attr("id"))},_mobileMenuDisable=function(submenu,expander){expander.removeAttr("tabindex aria-haspopup aria-owns aria-controls aria-expanded"),submenu.removeAttr("role aria-expanded aria-hidden aria-labelledby")},_mobileMenuInit=function(mobilesubmenus){var nav=(this.settings,this.nav),menu=this.menu,menutoggler=nav.find("#toggle-mobile-mainmenu"),searchform=nav.find("#sitesearch"),searchtoggler=nav.find("#toggle-mobile-search");mobileMenuMq.addListener(function(){mobileMenuMq.matches?($(nav).find("button.mobile-toggler").attr({"aria-hidden":!1}),_mobileMenuEnable.call(this,menu,menutoggler),_mobileMenuEnable.call(this,searchform,searchtoggler),mobilesubmenus.each(function(i,submenu){submenu=$(submenu);var expander=submenu.prevAll(".mobile-submenu-expander").eq(0);expander.attr("tabindex")||_mobileMenuEnable.call(this,submenu,expander)})):($(nav).find(".mobile-toggler").attr({"aria-hidden":!0}),_mobileMenuDisable.call(this,menu,menutoggler),_mobileMenuDisable.call(this,searchform,searchtoggler),mobilesubmenus.each(function(i,submenu){submenu=$(submenu);var expander=submenu.prevAll(".mobile-submenu-expander").eq(0);expander.attr("tabindex")&&_mobileMenuDisable.call(this,submenu,expander)}))})},_toggleMobilePanel=function(event,hide){var target=$(event.target),that=this,settings=that.settings,menu=that.menu,openMobilePanels=menu.find(".mobile-submenu-expander."+settings.openClass).not(target);hide?target.attr("aria-expanded","false").removeClass(settings.openClass).siblings("ul").attr("aria-expanded","false").attr("aria-hidden","true").removeClass(settings.openClass):(openMobilePanels.attr("aria-expanded","false").removeClass(settings.openClass).siblings("ul").attr("aria-expanded","false").attr("aria-hidden","true").removeClass(settings.openClass),target.attr("aria-expanded","true").addClass(settings.openClass).siblings("ul").attr("aria-expanded","true").attr("aria-hidden","false").addClass(settings.openClass))},_splitListItems=function(element,list){for(var capacity=40,i=0,countToTen=0,currentULposition=0,hits=list.find("li"),numRows=Math.ceil(hits.length/10),c=0;numRows>c;c++)element.append('<div class="footer-col"><ul></ul></div>');var ulColList=element.find("ul");$(hits).each(function(){capacity>=i&&(10>countToTen&&4>currentULposition?(ulColList[currentULposition].appendChild($(this)[0]),i++,countToTen++):countToTen>9&&(currentULposition++,ulColList[currentULposition].appendChild($(this)[0]),countToTen=1,i++))})},_getFooterLinks=function(element){var topli=element,target=topli.find("a:first"),href=target.attr("href"),panel=topli.find(".accessible-megafooter-panel");!panel.find("ul").length>0&&(target.attr("aria-busy","true"),panel.append('<div class="spinner"></div>'),$.ajax({type:"GET",url:href}).always(function(){target.attr("aria-busy","false"),panel.find(".spinner").remove(),panel.find("p").remove()}).fail(function(){window.location=href}).done(function(msg){var html=$.parseHTML(msg),list=$("#content-a-z",html).find("ul");list.length>0?$("html").hasClass("no-csscolumns")?_splitListItems(panel,list):list.removeClass().addClass("footer-columns").appendTo(panel):panel.append("<p>Fant ikke innhold</p>")})),setTimeout(function(){var scrollTarget=$(window).scrollTop()+$(window).height(),offset=topli.offset().top,distanceFromFold=scrollTarget-offset;300>distanceFromFold&&$("html,body").animate({scrollTop:$(window).scrollTop()+(300-distanceFromFold)})},500)},_getPlugin=function(element){return $(element).closest(":data(plugin_"+pluginName+")").data("plugin_"+pluginName)},_addUniqueId=function(element){element=$(element);var settings=this.settings;element.attr("id")||element.attr("id",settings.uuidPrefix+"-"+(new Date).getTime()+"-"+ ++uuid)},_togglePanel=function(event,hide){var target=$(event.target),that=this,settings=this.settings,menu=this.menu,topli=target.closest("."+settings.topNavItemClass);if(target.hasClass(settings.panelClass)?target:target.closest("."+settings.panelClass),_toggleExpandedEventHandlers.call(this,hide),menu.hasClass("m-open")||$("html").off("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu, pointerup.outside-accessible-megamenu",_clickOutsideHandler),hide)topli=menu.find("."+settings.topNavItemClass+" ."+settings.openClass+":first").closest("."+settings.topNavItemClass),topli.find("[aria-expanded]").attr("aria-expanded","false").removeClass(settings.openClass).filter(".mobile-submenu, ."+settings.panelClass).attr("aria-hidden","true"),that.animTimeoutID=setTimeout(function(){topli.find("."+settings.jsAnimatedClass).removeClass(settings.jsAnimatedClass)},300),menu.removeClass(settings.jsMenuExpandedClass);else{clearTimeout(that.focusTimeoutID),clearTimeout(that.animTimeoutID);var footerLinksContainer=topli.find(".accessible-megafooter-panel");footerLinksContainer.length>0&&(footerLinksContainer.hasClass("content-loaded")||_getFooterLinks(topli)),topli.siblings().removeClass(settings.selectedTopNavItem).find("[aria-expanded]").attr("aria-expanded","false").removeClass(settings.openClass).removeClass(settings.jsAnimatedClass).filter(".mobile-submenu, ."+settings.panelClass).attr("aria-hidden","true"),topli.addClass(settings.selectedTopNavItem).find("[aria-expanded]").not(".mobile-submenu-expander, .mobile-submenu").attr("aria-expanded","true").addClass(settings.openClass).addClass(settings.jsAnimatedClass).filter("."+settings.panelClass).attr("aria-hidden","false"),menu.addClass(settings.jsMenuExpandedClass),_toggleExpandedEventHandlers.call(that)}},_toggleMobileMenuAndSearch=function(event,hide){var target=$(event.target),that=this,nav=(this.settings,this.nav),menu=this.menu,togglers=nav.find("button.mobile-toggler");_toggleExpandedEventHandlers.call(this,hide),$("html").off("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu, pointerup.outside-accessible-megamenu",_clickOutsideHandler),hide?(togglers.removeClass("m-open").attr("aria-expanded",!1),menu.add("#sitesearch").removeClass("m-open").attr({"aria-expanded":!1,"aria-hidden":!0})):(target.addClass("m-open").attr("aria-expanded",!0).siblings("button.mobile-toggler").removeClass("m-open").attr("aria-expanded",!1),$("#"+target.attr("aria-controls")).addClass("m-open").attr({"aria-expanded":!0,"aria-hidden":!1}),$("#"+target.siblings("button.mobile-toggler").attr("aria-controls")).removeClass("m-open").attr({"aria-expanded":!1,"aria-hidden":!0}),_toggleExpandedEventHandlers.call(that))},_clickHandler=function(event){var target=$(event.target),topli=target.closest("."+this.settings.topNavItemClass),toplink=topli.find("a:first"),panel=target.closest("."+this.settings.panelClass);target.is("a > span")&&(target=target.parent("a")),1===topli.length&&0===panel.length&&1===topli.find("."+this.settings.panelClass).length&&target[0]===toplink[0]?(event.preventDefault(),event.stopPropagation(),target.hasClass(this.settings.openClass)?_togglePanel.call(this,event,target.hasClass(this.settings.openClass)):_togglePanel.call(this,event)):target.is("[tabindex].mobile-submenu-expander")?(event.preventDefault(),event.stopPropagation(),target.hasClass(this.settings.openClass)?_toggleMobilePanel.call(this,event,!0):_toggleMobilePanel.call(this,event)):target.is("button.mobile-toggler")&&(target.is(".m-open")?_toggleMobileMenuAndSearch.call(this,event,!0):_toggleMobileMenuAndSearch.call(this,event))},_clickOutsideHandler=function(event){var target=$(event.target);return(window.navigator.msPointerEnabled||window.navigator.pointerEnabled)&&"html"===target.context.localName?!1:(0===this.interactiveArea.has(target).length&&0===this.mobileMenuTogglers.filter(target).length&&(event.preventDefault(),event.stopPropagation(),_togglePanel.call(this,event,!0),this.settings.enableMobileMenu&&this.nav.has(".m-open").length&&_toggleMobileMenuAndSearch.call(this,event,!0)),void 0)},_keyDownHandler=function(event){var next,start,i,o,label,regex,target=$($(this).is(".hover:tabbable")?this:event.target),that=target.is(event.target)?this:_getPlugin(target),settings=that.settings,menu=that.menu,topnavitems=that.topnavitems,topli=target.closest("."+settings.topNavItemClass),tabbables=menu.find(":tabbable"),panel=target.hasClass(settings.panelClass)?target:target.closest("."+settings.panelClass),panelGroups=panel.find("."+settings.panelGroupClass),currentPanelGroup=target.closest("."+settings.panelGroupClass),keycode=event.keyCode||event.which,found=!1,newString=Keyboard.keyMap[event.keyCode]||"",isTopNavItem=1===topli.length&&0===panel.length,isMobileSubmenuExpander=target.is(".mobile-submenu-expander");if($(event.target).is("input"))return!0;switch(target.is(".hover:tabbable")&&$("html").off("keydown.accessible-megamenu"),keycode){case Keyboard.ESCAPE:_togglePanel.call(that,event,!0);break;case Keyboard.DOWN:event.preventDefault(),isTopNavItem?(_togglePanel.call(that,event),setTimeout(function(){found=1===topli.find("."+settings.panelClass+" :tabbable:first").focus().length},100)):found=1===tabbables.filter(":gt("+tabbables.index(target)+"):first").focus().length,!found&&window.opera&&"[object Opera]"===opera.toString()&&(event.ctrlKey||event.metaKey)&&(tabbables=$(":tabbable"),i=tabbables.index(target),found=1===$(":tabbable:gt("+$(":tabbable").index(target)+"):first").focus().length);break;case Keyboard.UP:event.preventDefault(),isTopNavItem&&target.hasClass(settings.openClass)?(_togglePanel.call(that,event,!0),next=topnavitems.filter(":lt("+topnavitems.index(topli)+"):last"),next.children("."+settings.panelClass).length&&(found=1===next.children().attr("aria-expanded","true").addClass(settings.openClass).filter("."+settings.panelClass).attr("aria-hidden","false").find(":tabbable:last").focus())):isTopNavItem||(found=1===tabbables.filter(":lt("+tabbables.index(target)+"):last").focus().length),!found&&window.opera&&"[object Opera]"===opera.toString()&&(event.ctrlKey||event.metaKey)&&(tabbables=$(":tabbable"),i=tabbables.index(target),found=1===$(":tabbable:lt("+$(":tabbable").index(target)+"):first").focus().length);break;case Keyboard.RIGHT:event.preventDefault(),isTopNavItem?found=1===topnavitems.filter(":gt("+topnavitems.index(topli)+"):first").find(":tabbable:first").focus().length:(panelGroups.length&&currentPanelGroup.length&&(found=1===panelGroups.filter(":gt("+panelGroups.index(currentPanelGroup)+"):first").find(":tabbable:first").focus().length),found||(found=1===topli.find(":tabbable:first").focus().length));break;case Keyboard.LEFT:event.preventDefault(),isTopNavItem?found=1===topnavitems.filter(":lt("+topnavitems.index(topli)+"):last").find(":tabbable:first").focus().length:(panelGroups.length&&currentPanelGroup.length&&(found=1===panelGroups.filter(":lt("+panelGroups.index(currentPanelGroup)+"):last").find(":tabbable:first").focus().length),found||(found=1===topli.find(":tabbable:first").focus().length));break;case Keyboard.TAB:i=tabbables.index(target),event.shiftKey&&isTopNavItem&&target.hasClass(settings.openClass)||(event.shiftKey&&i>0?found=1===tabbables.filter(":lt("+i+"):last").focus().length:!event.shiftKey&&i<tabbables.length-1?found=1===tabbables.filter(":gt("+i+"):first").focus().length:window.opera&&"[object Opera]"===opera.toString()&&(tabbables=$(":tabbable"),i=tabbables.index(target),found=event.shiftKey?1===$(":tabbable:lt("+$(":tabbable").index(target)+"):last").focus().length:1===$(":tabbable:gt("+$(":tabbable").index(target)+"):first").focus().length)),found&&event.preventDefault();break;case Keyboard.SPACE:(isTopNavItem||isMobileSubmenuExpander)&&(event.preventDefault(),_clickHandler.call(that,event));break;default:if(isMobileSubmenuExpander&&Keyboard.ENTER&&(event.preventDefault(),_clickHandler.call(that,event)),clearTimeout(this.keydownTimeoutID),keydownSearchString+=newString!==keydownSearchString?newString:"",0===keydownSearchString.length)return;for(this.keydownTimeoutID=setTimeout(function(){keydownSearchString=""},keydownTimeoutDuration),tabbables=isTopNavItem&&!target.hasClass(settings.openClass)?tabbables.filter("."+settings.topNavItemClass+" > :tabbable"):topli.find(":tabbable"),event.shiftKey&&(tabbables=$(tabbables.get().reverse())),i=0;i<tabbables.length;i++)if(o=tabbables.eq(i),o.is(target)){start=1===keydownSearchString.length?i+1:i;break}for(regex=new RegExp("^"+keydownSearchString.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),"i"),i=start;i<tabbables.length;i++)if(o=tabbables.eq(i),label=$.trim(o.text()),regex.test(label)){found=!0,o.focus();break}if(!found)for(i=0;start>i;i++)if(o=tabbables.eq(i),label=$.trim(o.text()),regex.test(label)){o.focus();break}}that.justFocused=!1},_toggleExpandedEventHandlers=function(hide){var menu=this.menu;hide&&!menu.hasClass("m-open")?$("html").off("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu,  pointerup.outside-accessible-megamenu",_clickOutsideHandler):$("html").on("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu,  pointerup.outside-accessible-megamenu",$.proxy(_clickOutsideHandler,this))},{constructor:AccessibleMegaMenu,init:function(){var that=this,settings=this.settings,nav=(this.justFocused=!1,this.nav=$(this.element)),menu=this.menu=nav.find("ul").first(),mobileMenuTogglers=this.mobileMenuTogglers=nav.find("button.mobile-toggler"),interactiveArea=this.interactiveArea=settings.enableMobileMenu?menu.add(mobileMenuTogglers).add($("#sitesearch")):menu,topnavitems=this.topnavitems=menu.children(),touchMoved=!1,touchEventFired=!1,touchStartX=0,touchStartY=0;if(topnavitems.each(function(i,topnavitem){var topnavitemlink,topnavitempanel;topnavitem=$(topnavitem),topnavitem.addClass(settings.topNavItemClass),topnavitemlink=topnavitem.find("a:first"),topnavitempanel=topnavitem.find(".panel-wrapper").children(":not(:tabbable):last"),_addUniqueId.call(that,topnavitemlink),topnavitempanel.length&&(_addUniqueId.call(that,topnavitempanel),topnavitemlink.attr({"aria-haspopup":!0,"aria-owns":topnavitempanel.attr("id"),"aria-controls":topnavitempanel.attr("id"),"aria-expanded":!1}),topnavitempanel.attr({role:"group","aria-expanded":!1,"aria-hidden":!0}).addClass(settings.panelClass).not("[aria-labelledby]").attr("aria-labelledby",topnavitemlink.attr("id")))}),settings.enableMobileMenu){var mobilesubmenus=topnavitems.find(".mobile-submenu:not(.languages)");mobileMenuMq.matches?($(nav).find("button.mobile-toggler").attr({"aria-hidden":!1}),$(nav).find("label.mobile-toggler, input.mobile-toggler").attr({"aria-hidden":!0}),_mobileMenuEnable.call(that,menu,$("#toggle-mobile-mainmenu")),_mobileMenuEnable.call(that,$("#sitesearch"),$("#toggle-mobile-search"))):$(nav).find(".mobile-toggler").attr({"aria-hidden":!0}),mobilesubmenus.each(function(i,submenu){submenu=$(submenu);var expander=submenu.prevAll(".mobile-submenu-expander").eq(0);_addUniqueId.call(that,submenu),_addUniqueId.call(that,expander),mobileMenuMq.matches&&_mobileMenuEnable.call(that,submenu,expander)}),_mobileMenuInit.call(that,mobilesubmenus)}isTouch?interactiveArea.on("touchstart.accessible-megamenu",function(e){var pointer=_getTouchEvent(e);touchMoved=!1,touchStartX=pointer.clientX,touchStartY=pointer.clientY}).on("touchmove.accessible-megamenu",function(e){var pointer=_getTouchEvent(e);(Math.abs(pointer.clientX-touchStartX)>10||Math.abs(pointer.clientY-touchStartY)>10)&&(touchMoved=!0)}).on("touchend.accessible-megamenu",function(e){touchMoved?e.stopImmediatePropagation():touchEventFired=!0}).on("touchend.accessible-megamenu",$.proxy(_clickHandler,this)).on("click.accessible-megamenu",function(e){var target=$(e.target);!touchEventFired||target.is("a:not([aria-expanded])")||target.is("input")||(e.preventDefault(),e.stopImmediatePropagation())}).on("click.accessible-megamenu",$.proxy(_clickHandler,this)):interactiveArea.on("click.accessible-megamenu",$.proxy(_clickHandler,this)),interactiveArea.on("keydown.accessible-megamenu",$.proxy(_keyDownHandler,this))},getDefaults:function(){return this._defaults},getOption:function(opt){return this.settings[opt]},getAllOptions:function(){return this.settings},setOption:function(opt,value,reinitialize){this.settings[opt]=value,reinitialize&&this.init()}}}(),$.fn[pluginName]=function(options){return this.each(function(){$.data(this,"plugin_"+pluginName)||$.data(this,"plugin_"+pluginName,new AccessibleMegaMenu(this,options))})},$.extend($.expr[":"],{data:$.expr.createPseudo?$.expr.createPseudo(function(dataName){return function(elem){return!!$.data(elem,dataName)}}):function(elem,i,match){return!!$.data(elem,match[3])},focusable:function(element){return focusable(element,!isNaN($.attr(element,"tabindex")))},tabbable:function(element){var tabIndex=$.attr(element,"tabindex"),isTabIndexNaN=isNaN(tabIndex);return(isTabIndexNaN||tabIndex>=0)&&focusable(element,!isTabIndexNaN)}})}(jQuery,window,document),$(document).ready(function(){$("#mainmenu").accessibleMegaMenu({enableMobileMenu:!0}),$("#footer-content-menu").accessibleMegaMenu({uuidPrefix:"accessible-megafooter",menuClass:"accessible-megafooter",topNavItemClass:"letter",panelClass:"accessible-megafooter-panel",selectedTopNavItem:"selected-letter"})});